---

- name: Gather default and custom facts
  hosts: 'all:!localhost'
  gather_facts: True
  sudo: False

  tasks:
    - name: Check IP address of Ansible Controller
      set_fact:
        ansible_controller: '{{ ansible_env.SSH_CLIENT.split(" ") | first }}'
      when: (ansible_controller is undefined and ansible_connection != "local")
      tags: [ 'ferm', 'tcpwrappers' ]

    - name: Update APT cache early if older than 24h
      apt:
        update_cache: True
        cache_valid_time: '{{ apt_update_cache_early }}'
      when: (apt_update_cache_early is defined and apt_update_cache_early)
      sudo: True

    - name: Enforce new hostname if requested
      hostname:
        name: '{{ fqdn_hostname }}'
      when: fqdn_hostname is defined and fqdn_hostname
      sudo: True
      tags: fqdn

    - name: Save enforced hostname if requested
      copy:
        content: '{{ fqdn_hostname + "\n" }}'
        dest: '/etc/hostname'
        owner: 'root'
        group: 'root'
        mode: '0644'
      when: fqdn_hostname is defined and fqdn_hostname
      sudo: True
      tags: fqdn

    - name: Ensure domain is defined if requested
      lineinfile:
        state: 'present'
        dest: '/etc/hosts'
        regexp: '{{ "^" + (fqdn_ipv4 | default("127.0.1.1")) | replace(".","\.") }}'
        line: '{{ (fqdn_ipv4 | default("127.0.1.1")) + "\t" + (fqdn_hostname | default(ansible_hostname)) + "." + fqdn_domain + "\t" + (fqdn_hostname | default(ansible_hostname)) }}'
      when: fqdn_domain is defined and fqdn_domain
      sudo: True
      tags: fqdn


- name: Common configuration for all hosts
  hosts: 'all:!localhost'
  gather_facts: True
  sudo: True

  roles:
    - { role: debops.apt_preferences,      tags: apt_preferences }
    - { role: debops.etc_services,         tags: etc_services }
    - { role: debops.auth,                 tags: auth }
    - { role: debops.pki,                  tags: pki }
    - { role: debops.apt,                  tags: apt }
    - { role: debops.ferm,                 tags: ferm }
    - { role: debops.ntp,                  tags: ntp }
    - { role: debops.sshd,                 tags: sshd }
    - { role: debops.ifupdown,             tags: ifupdown }
    - { role: debops.console,              tags: console }
    - { role: debops.postfix,              tags: postfix }
    - { role: debops.rsyslog,              tags: rsyslog }
    - { role: debops.tcpwrappers,          tags: tcpwrappers }
    - { role: debops.users,                tags: users }
    - { role: debops.sshkeys,              tags: sshkeys }
    - { role: debops.directories,          tags: directories }

