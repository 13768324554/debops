---

- name: Download OpenVZ template signing key
  command: 'gpg --keyserver {{ openvz_gnupg_keyserver }} --recv {{ openvz_gnupg_key_id }}'
  changed_when: False

- name: Add OpenVZ APT key
  apt_key: url={{ openvz_apt_repository_key_url }} id={{ openvz_apt_repository_key_id }}
           state=present

- name: Add OpenVZ APT repository
  apt_repository: repo='deb {{ openvz_apt_repository }} {{ openvz_apt_distribution }} main'
                  state=present update_cache=yes

- name: Install OpenVZ packages
  apt: pkg={{ item }} state=latest install_recommends=no
  with_items: [ 'vzctl', 'vzquota', 'vzdump', 'ploop', 'uuid-runtime' ]

- name: Configure firewall for OpenVZ
  template: src=etc/ferm/ferm.d/openvz.conf.j2 dest=/etc/ferm/ferm.d/openvz.conf
            owner=root group=root mode=0644
  notify: [ 'Restart ferm' ]

- name: Configure sysctl for OpenVZ
  template: src=etc/sysctl.d/openvz.conf.j2 dest=/etc/sysctl.d/openvz.conf
            owner=root group=root mode=0644
  notify: [ 'Reload sysctl' ]

- name: Symlink /var/lib/vz to /vz
  file:
    src: '/var/lib/vz'
    dest: '/vz'
    state: 'link'

- name: Configure OpenVZ
  template: src={{ item }}.j2 dest=/{{ item }} owner=root group=root mode=0644
  with_items: [ 'etc/vz/download.conf', 'etc/vz/vz.conf' ]

- name: Configure OpenVZ scripts
  template: src={{ item }}.j2 dest=/{{ item }} owner=root group=root mode=0755
  with_items: [ 'usr/local/sbin/easymac.sh', 'usr/local/sbin/vzbackup' ]

- include: exchange_keys.yml
- include: configure_kernel.yml
