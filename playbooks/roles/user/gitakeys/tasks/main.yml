---

# This set of tasks should be run under sudo = yes

- name: Configure ssh public key repository for {{ owner }}
  sudo_user: ${owner}
  lineinfile: dest=~/.ssh/git_authorized_keys regexp='^${user_gitakeys_github}${owner}/${repository}' line='${user_gitakeys_github}${owner}/${repository} ${keyfile} ${branch}' state=present create=yes backup=no
  tags:
    - ssh
    - user

- name: Check if ~/.ssh/authorized_keys needs to be updated for {{ owner }}
  sudo_user: ${owner}
  shell: update-authorized-keys --checksum
  register: update_authorized_keys
  ignore_errors: yes
  changed_when: "update_authorized_keys.stdout != 'Checksum OK'"
  tags:
    - ssh
    - user

- name: Update ~/.ssh/authorized_keys for {{ owner }}
  sudo_user: ${owner}
  shell: update-authorized-keys --quiet
  when: "update_authorized_keys.stdout != 'Checksum OK'"
  tags:
    - ssh
    - user

