---
# role: rails_deploy

# Check the bottom of this file for a few usage examples. You really only need
# to change 1 or 2 variables to have everything work with reasonable defaults.


# --- System ---

# Should postgresql or mysql and nginx be setup for you automatically?
# Redis will also be setup if you enable background worker support.
# Critical dependencies like nodejs and ruby will always be setup for you.
# If you want anything to be on a non-app host then you would remove it here.
rails_deploy_dependencies: ['database', 'redis', 'nginx']

# Which packages do you want installed?
# Add as many packages as you want, the database_package will automatically
# pick libpq-dev or libmysqlclient-dev depending on what database you picked.
rails_deploy_packages: ['{{ rails_deploy_database_package }}']

# A list of additional groups that this app's user belongs to.
# If you want to be able to ssh into the server then you must include 'sshusers'.
rails_deploy_user_groups: []

# Where should the public ssh key be read in from? This is only used when you
# have included 'sshusers' in the user_groups list.
rails_deploy_user_sshkey: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"


# --- Hosts ---

# What inventory group does your app belong to?
rails_deploy_hosts_group: '{{ groups["ginas_rails_" + rails_deploy_service] }}'

# Which application server should run database related tasks?
rails_deploy_hosts_master: '{{ rails_deploy_hosts_group[0] }}'


# --- Git ---

# The location repo which will get cloned during each deploy. You can use a
# remote or local repo.
rails_deploy_git_location: ''

# Which branch or tag should be used?
rails_deploy_git_version: 'master'

# Which remote should be used?
rails_deploy_git_remote: 'origin'

# Supply your git provider's api token to automatically set deploy keys.
# If False you will have to manually add deploy keys for each app server.

# Supports github and gitlab for now:
# Github: https://github.com/settings/applications
#   Under personal access tokens, check off 'write:public_key'.
#     You may want to enable other access limits for repo/public_repo, etc..
#
# Gitlab: https://yourgitlabhost.com/profile/account
#   Your private token should already be there.
rails_deploy_git_access_token: False


# --- Deploy ---

# What should the service be named?
# The default value plucks out your repo name (without .git) from your location.
rails_deploy_service: "{{ rails_deploy_git_location | basename | replace('.git', '') }}"

# What should the system environment be set to?
rails_deploy_system_env: 'production'

# A list of environments to skip, it will remove your system env from the list
# during the deploy phase automatically.
rails_deploy_bundle_without: ['development', 'staging', 'production', 'test']


# --- Backend ---

# Which backend type are you using? 'unicorn' and 'puma' are supported so far.
rails_deploy_backend: 'unicorn'

# What do you want to listen on? You can choose a tcp addr:port or unix socket.
# Do not bother to include the socket/tcp prefix, that will be handled for you.
rails_deploy_backend_bind: '{{ rails_deploy_service_socket }}'

# What state should the backend be in?
rails_deploy_backend_state: 'started'
rails_deploy_backend_enabled: True

# When set to true the backend will always restart instead of reload but it
# will only restart if the repo changed. This makes for hands free deployment
# at the cost of a few seconds+ of downtime per deploy.
#
# You may want to combine this with force migrate in which case all you ever have
# to do is push your app and you don't have to wonder whether or not the code
# you're changing requires a full restart or not.
rails_deploy_backend_always_restart: False


# --- Database ---

# Should the database be created by default?
rails_deploy_database_create: True

# Should the database get a db:schema:load and db:seed in an idempotent way?
rails_deploy_database_prepare: True

# Should the database get automatically migrated in an idempotent way?
rails_deploy_database_migrate: True

# Should the database get migrated no matter what?
# You may want to do this as a 1 off command with --extra-vars in case your
# schema file's checksum somehow gets out of sync and you need to migrate.
#
# Another use case would be if you have automatic migrations turned off and
# you just deployed but now you want to do an isolated migration.
rails_deploy_database_force_migrate: False

# It supports 'postgresql' or 'mysql' for now.
rails_deploy_database_adapter: 'postgresql'

# Make sure this matches your pg cluster info, ignore it if you use mysql.
rails_deploy_postgresql_cluster: '9.1/main'

# Where is your database hosted?
rails_deploy_database_host: '{{ ansible_fqdn }}'
rails_deploy_database_port: '5432' # 3306 for mysql

# What are your super user names?
rails_deploy_postgresql_super_username: 'postgres'
rails_deploy_mysql_super_username: 'mysql'

# What should some of the configuration options be set to?
rails_deploy_database_pool: 25
rails_deploy_database_timeout: 5000


# --- Background Worker ---

# Enable background worker support. This will create an init.d service, register
# it with monit and add it into the deploy life cycle.
rails_deploy_worker_enabled: False
rails_deploy_worker_state: 'started'

# At the moment it only supports sidekiq but resque could happen in the future.
rails_deploy_worker: 'sidekiq'

# Where is your worker hosted?
rails_deploy_worker_host: '{{ ansible_fqdn }}'
rails_deploy_worker_port: '6379'

# How should the connection be made to the redis server?
# If your server has a password you must add it here.
# Example: redis://:mypassword@{{ rails_deploy_worker_host }}:{{ rails_deploy_worker_port }}/0'
rails_deploy_worker_url: 'redis://{{ rails_deploy_worker_host }}:{{ rails_deploy_worker_port }}/0'


# --- Tasks ---

# Precompile assets and remove any temporary cache files on each deploy.
# Add or remove as many tasks as you want. They are executed in the context
# of the root directory of your app and only happen when the repo changes.
rails_deploy_default_tasks:
  - 'bundle exec rake assets:precompile'
  - 'rm -rf tmp/cache'

# Execute tasks before and/or after your backend is reloaded/restarted.
rails_deploy_early_tasks:
  # Example, let's say you wanted to execute whenever also:
  # - 'bundle exec whenever --clear-crontab {{ rails_deploy_service }}'

# This is the absolute last thing that happens during a deploy.
rails_deploy_late_tasks: []


# --- Services ---

# Add 1 or more custom services related to the app, they will have
# their state changed on each deploy. The changed_state is the action to
# take when the state of the git repo has changed.

# They will get restarted/reloaded at the end of the deploy.
# Everything is optional except for the name.
rails_deploy_extra_services: []

#rails_deploy_extra_services:
#  - name: ''
#    changed_state: 'reloaded'
#    state: 'started'
#    enabled: True


# --- Environment settings ---

# Both the default and custom environment variables will get added together
# and be written to /etc/default/{{ rails_deploy_service }}.

# Default environment variables added to each app.
rails_deploy_default_env:
  RAILS_ENV: '{{ rails_deploy_system_env }}'

  DATABASE_URL: "{{ rails_deploy_database_adapter }}://{{ rails_deploy_service }}:{{ rails_deploy_database_user_password }}@{{ rails_deploy_database_host }}:{{ rails_deploy_database_port }}/{{ rails_deploy_service }}_{{ rails_deploy_system_env }}?pool={{ rails_deploy_database_pool }}&timeout={{ rails_deploy_database_timeout }}"

  # Application variables, they are used in the backend/worker variables below.
  SERVICE: '{{ rails_deploy_service }}'
  LOG_PATH: '{{ rails_deploy_log }}'
  RUN_STATE_PATH: '{{ rails_deploy_run }}'

  # Backend variables, they work in conjunction with the example
  # server configs. Check docs/examples/rails/config/puma.rb|unicorn.rb.
  LISTEN_ON: '{{ rails_deploy_backend_bind }}'

  THREADS_MIN: 0
  THREADS_MAX: 16
  WORKERS: 2

  # Background worker variables. Check docs/examples/rails/config/sidekiq.yml
  # and initializers/sidekiq.rb on how use this in your application.
  BACKGROUND_URL: '{{ rails_deploy_worker_url }}'
  BACKGROUND_THREADS: '{{ rails_deploy_database_pool }}'

# Custom environment variables added to a specific app.
rails_deploy_env: {}


# --- Nginx settings ---

# Should nginx be enabled?
rails_deploy_nginx_server_enabled: True

# What domain names should the app be associated to?
rails_deploy_nginx_domains: ['{{ ansible_fqdn }}']

# If you want to edit any of the values for nginx below, you will need to copy
# the whole variable over even if you need to edit 1 value.
#
# Consult the ginas.nginx documentation if needed.

# Configure the upstream.
rails_deploy_nginx_upstream:
  enabled: '{{ rails_deploy_nginx_server_enabled }}'
  name: '{{ rails_deploy_service }}'
  server: "{{ 'unix:' + rails_deploy_backend_bind if not ':' in rails_deploy_backend_bind else rails_deploy_backend_bind }}"

# Configure the sites-available.
rails_deploy_nginx_server:
  enabled: '{{ rails_deploy_nginx_server_enabled }}'
  default: False
  name: '{{ rails_deploy_nginx_domains }}'
  root: '{{ rails_deploy_src }}/public'

  error_pages:
    '404': '/404.html'
    '422': '/422.html'
    '500': '/500.html'
    '502 503 504': '/502.html'

  location_list:
    - pattern: '/'
      options: |
        try_files $uri $uri/index.html $uri.html @{{ rails_deploy_nginx_upstream.name }};
    - pattern: '~ ^/(assets|system)/'
      options: |
        gzip_static on;
        expires max;
        add_header Cache-Control public;
        add_header Last-Modified "";
        add_header ETag "";
    - pattern: '@{{ rails_deploy_nginx_upstream.name }}'
      options: |
        gzip off;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Host              $http_host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_redirect     off;
        proxy_pass         http://{{ rails_deploy_nginx_upstream.name }};


# Usage examples:

# --- Bare minimum ---
#rails_deploy_git_location: 'git@github.com:yourname/mycoolapp.git'

# --- Use a custom service name ---
#rails_deploy_service: 'myawesomeapp'

# --- Use a tag or branch instead of master ---
#rails_deploy_git_version: 'v0.1.0'

# --- Use mysql instead of postgres ---
#rails_deploy_database_adapter: 'mysql'

# --- Use puma instead of unicorn ---
#rails_deploy_backend: 'puma'

# --- Enable the background worker ---
#rails_deploy_worker_enable: True

# --- Listen on a tcp port instead of a socket ---
#rails_deploy_backend_bind: '{{ ansible_fqdn }}:8080'

# --- Deploy to staging instead of production ---
#rails_deploy_system_env: 'staging'
