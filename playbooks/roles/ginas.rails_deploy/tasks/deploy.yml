- name: Show the deploy page
  command: cp public/deploy.html public/index.html
           chdir={{ rails_deploy_src }}
  sudo_user: '{{ rails_deploy_service }}'

- name: Clone the app's source code
  git: repo={{ rails_deploy_git_location }} dest={{ rails_deploy_src }}
       version={{ rails_deploy_git_version }}
       origin={{ rails_deploy_git_origin }} accept_hostkey=yes
  register: rails_deploy_register_repo_status
  when: rails_deploy_git_location is defined and rails_deploy_git_location
  sudo_user: '{{ rails_deploy_service }}'

- name: Update gems
  command: bundle install --deployment --without={{ rails_deploy_bundle_without | difference([rails_deploy_system_env]) | join(',') }}
           chdir={{ rails_deploy_src }}
  when: rails_deploy_register_repo_status is defined and
        rails_deploy_register_repo_status | changed
  sudo_user: '{{ rails_deploy_service }}'

- name: Prepare the database
  shell: '{{ rails_deploy_env_source }} && bundle exec rake db:schema:load db:seed
           chdir={{ rails_deploy_src }}'
  when: rails_deploy_database_create and rails_deploy_register_database_created is defined and
        rails_deploy_register_database_created | changed and
        rails_app_database_prepare) and
        inventory_hostname == rails_deploy_hosts_master and
        rails_deploy_register_repo_status is defined and
        rails_deploy_register_repo_status | changed
  sudo_user: '{{ rails_deploy_service }}'

- name: Store mtime of the config folder
  stat: path={{ rails_deploy_src }}/config
  register: rails_deploy_register_mtime_config
  when: inventory_hostname == rails_deploy_hosts_master and
        rails_deploy_git_location is defined and rails_deploy_git_location

- name: Store mtime of the db/schema.rb file
  stat: path={{ rails_deploy_src }}/db/schema.rb
  register: rails_deploy_register_mtime_schema
  when: inventory_hostname == rails_deploy_hosts_master and
        rails_deploy_git_location is defined and rails_deploy_git_location

- name: Migrate the database
  shell: '{{ rails_deploy_env_source }} && bundle exec rake db:migrate chdir={{ rails_deploy_src }}'
  when: inventory_hostname == rails_deploy_hosts_master and
        (rails_deploy_database_force_migrate or
        (rails_deploy_register_repo_status is defined and
        rails_deploy_register_repo_status | changed and
        (rails_deploy_register_mtime_schema.stat.mtime != ansible_local.rails_deploy[rails_deploy_service].mtime.schema) or
        ansible_local.rails_deploy[rails_deploy_service].mtime.schema is undefined))
  register: rails_deploy_register_migration
  sudo_user: '{{ rails_deploy_service }}'

- name: Execute default tasks
  shell: '{{ rails_deploy_env_source }} && {{ item }} chdir={{ rails_deploy_src }}'
  when: rails_deploy_default_tasks and rails_deploy_git_location and
        rails_deploy_register_repo_status is defined and
        rails_deploy_register_repo_status | changed
  with_items: rails_deploy_default_tasks
  sudo_user: '{{ rails_deploy_service }}'

- name: Execute tasks before the backend is ready
  shell: '{{ rails_deploy_env_source }} && {{ item }} chdir={{ rails_deploy_src }}'
  when: rails_deploy_early_tasks and rails_deploy_git_location and
        rails_deploy_register_repo_status is defined and
        rails_deploy_register_repo_status | changed
  with_items: rails_deploy_early_tasks
  sudo_user: '{{ rails_deploy_service }}'

- name: Reload the backend server
  service: name={{ rails_deploy_service }} state=reloaded
  when: rails_deploy_register_repo_status is defined and
        rails_deploy_register_repo_status | changed and
        (inventory_hostname == rails_deploy_hosts_master or
        inventory_hostname != item) and
        not rails_deploy_register_migration | changed and
        rails_deploy_register_mtime_config.stat.mtime == ansible_local.rails_deploy[rails_deploy_service].mtime.config and
        not rails_deploy_backend_always_restart
  delegate_to: '{{ item }}'
  with_items: rails_deploy_hosts_group

- name: Restart the backend server
  service: name={{ rails_deploy_service }} state=restarted
  when: rails_deploy_database_force_migrate or
        ((rails_deploy_register_repo_status is defined and
        rails_deploy_register_repo_status | changed) and rails_deploy_register_migration | changed) and
        (inventory_hostname == rails_deploy_hosts_master or
        inventory_hostname != item)
        or
        rails_deploy_register_mtime_config.stat.mtime != ansible_local.rails_deploy[rails_deploy_service].mtime.config or
        (rails_deploy_backend_always_restart and rails_deploy_git_location and
        rails_deploy_register_repo_status is defined and
        rails_deploy_register_repo_status | changed)
  delegate_to: '{{ item }}'
  with_items: rails_deploy_hosts_group

- name: Set the extra services state
  service: name={{ item.name }}
           state={{ item.changed_state | default('reloaded') }}
  when: rails_deploy_register_repo_status is defined and
        rails_deploy_register_repo_status | changed and rails_deploy_extra_services
  with_items: rails_deploy_extra_services

- name: Set the initial backend server state
  service: name={{ rails_deploy_service }}
           state={{ rails_deploy_backend_state }}
           enabled={{ rails_deploy_backend_enabled }}
  when: rails_deploy_git_location is defined and rails_deploy_git_location

- name: Set the initial extra services state
  service: name={{ item.name }}
           state={{ item.state | default('started') }}
           enabled={{ item.enabled | default(True) }}
  when: rails_deploy_git_location is defined and rails_deploy_git_location and
        rails_deploy_extra_services
  with_items: rails_deploy_extra_services

- name: Execute tasks after the backend is ready
  shell: '{{ rails_deploy_env_source }} && {{ item }} chdir={{ rails_deploy_src }}'
  when: rails_deploy_late_tasks and rails_deploy_git_location and
        rails_deploy_register_repo_status is defined and
        rails_deploy_register_repo_status | changed
  with_items: rails_deploy_late_tasks
  sudo_user: '{{ rails_deploy_service }}'
