# {{ ansible_managed }}
{#

  Default nginx server template

#}

server {
{% if item.listen is defined %}
	listen{% for port in item.listen %} {{ port }}{% endfor %};
{% else %}
	listen 80;
{% endif %}
{% if item.name is defined and item.name %}
	server_name {{ item.name }}{% if item.alias is defined and item.alias %}{% for domain in item.alias %} {{ domain }}{% endfor %}{% endif %}{% if nginx_default_name is defined and nginx_default_name == item.name or item.default is defined and not item.default %} default{% endif %};
{% elif item.name is not defined and item.default is defined and item.default %}
	server_name default;
{% endif %}

{% if item.root is defined and item.root %}
	root {{ item.root }};
{% elif item.name is defined and item.name %}
{% if item.owner is defined and item.owner %}
	root /srv/www/{{ item.owner }}/sites/{{ item.name }}/public;
{% else %}
	root /srv/www/sites/{{ item.name }}/public;
{% endif %}
{% else %}
	root {{ nginx_default_root }};
{% endif %}

{% if item.name is defined and item.name %}
	access_log /var/log/nginx/{{ item.name }}_access.log;
	error_log /var/log/nginx/{{ item.name }}_error.log;

{% endif %}
	index index.html index.htm{% if item.location_php5 is defined and item.location_php5 %} index.php{% endif %};

	# Disallow access to hidden files and directories
	location ~ /\. {
		return 404;
		access_log off;
		log_not_found off;
	}

	location = /favicon.ico {
		try_files /favicon.ico =204;
		access_log off;
		log_not_found off;
	}

{% if item.status is defined and item.status or nginx_default_status is defined and nginx_default_status %}
	location = /nginx_status {
		stub_status on;
		access_log off;
{% if nginx_default_status is defined and nginx_default_status %}
{% for address in nginx_default_status %}
		allow {{ address }};
{% endfor %}
{% endif %}
{% if item.status is defined and item.status %}
{% for address in item.status %}
		allow {{ address }};
{% endfor %}
{% endif %}
		deny all;
	}

{% if item.location_php5 is defined and item.location_php5 %}
{#
      !!! You need to enable pm_status variable in php5 pool for this to work !!!
#}
	location = {{ item.location_php5_status | default('/php5_status') }} {
		access_log off;
{% if nginx_default_status is defined and nginx_default_status %}
{% for address in nginx_default_status %}
		allow {{ address }};
{% endfor %}
{% endif %}
{% if item.status is defined and item.status %}
{% for address in item.status %}
		allow {{ address }};
{% endfor %}
{% endif %}
		deny all;

		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		include fastcgi_params;
		fastcgi_index index.php;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_pass {{ item.location_php5 }};
	}

	location = {{ item.location_php5_ping | default('/php5_ping') }} {
		access_log off;
{% if nginx_default_status is defined and nginx_default_status %}
{% for address in nginx_default_status %}
		allow {{ address }};
{% endfor %}
{% endif %}
{% if item.status is defined and item.status %}
{% for address in item.status %}
		allow {{ address }};
{% endfor %}
{% endif %}
		deny all;

		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		include fastcgi_params;
		fastcgi_index index.php;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_pass {{ item.location_php5 }};
	}

{% endif %}
{% endif %}
{% if item.name is defined and item.name == nginx_default_name or item.name is not defined and item.default is defined and item.default %}
	include /etc/nginx/http-default.d/*.conf;

{% elif item.name is not defined and item.default is not defined %}
	include /etc/nginx/http-default.d/*.conf;

{% endif %}
{% if item.location is defined %}
{% for path in item.location.keys() %}
	location {{ path }} {
{% for line in item.location[path] %}
		{{ line }};
{% endfor %}
	}

{% endfor %}
{% else %}
	location / {
		try_files $uri $uri/ $uri.html $uri.htm /index.html /index.htm =404;
	}

{% endif %}
{% if item.location_php5 is defined and item.location_php5 %}
	location ~ \.php$ {
		try_files $uri =404;

		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		include fastcgi_params;
		fastcgi_index index.php;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_pass {{ item.location_php5 }};
	}

{% else %}
	location ~ \.php$ {
		return 403;
	}

{% endif %}
}


