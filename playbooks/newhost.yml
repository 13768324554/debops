---

# playbooks/newhost.yml
#
# This playbook creates initial admin account and ensures that ansible can
# access the server through sudo. You should run it just after new server has
# been installed and connected to the network. Make sure that you can access
# it through ssh on the root account. You might have to provide a password (in
# that case use '-k' switch on the command line).
#
# Usage:
# ansible-playbook -k playbooks/newhost.yml --extra-vars="hosts=<hostname>"
#
# After securing access to the server by disabling the password authentication
# in sshd, this playbook is expected to not work properly.

- hosts: $hosts
  user: root
  sudo: no
  tags: init
  vars:
  - ssh_user: $ENV(USER)

  tasks:
  - name: INIT | Create admin system group
    group: name=admins system=yes state=present
    tags: init

  - name: INIT | Create administrator account
    user: name=$ssh_user state=present shell=/bin/sh groups=admins
    tags: init

  - name: INIT | Make sure essential software is installed
    apt: pkg=$item state=latest install_recommends=no
    with_items:
      - python
      - python-apt
      - sudo
      - lsb-release
    tags: init

  - name: INIT | Install ssh public key from current account
    authorized_key: user=$ssh_user key="$FILE(~/.ssh/id_rsa.pub)"
    tags: init

  - name: INIT | Install sudoers file for admin accounts
    lineinfile: "dest=/etc/sudoers.d/admins state=present create=yes regexp='^%admins' line='%admins ALL=(ALL:ALL) NOPASSWD: SETENV: ALL' owner=root group=root mode=0440"
    tags: init

  - name: INIT | Remove generic /etc/motd
    file: path=/etc/motd state=absent
    tags: init

