---

- name: Install packages for Debian repository management
  apt:
    name: '{{ item }}'
    state: 'latest'
    install_recommends: False
  with_items: [ 'reprepro', 'dpkg-dev' ]

- name: Create system group for reprepro
  group:
    name: '{{ reprepro_group }}'
    system: True
    state: 'present'

- name: Create system user for reprepro
  user:
    name: '{{ reprepro_user }}'
    group: '{{ reprepro_group }}'
    system: True
    shell: '/bin/bash'
    home: '{{ reprepro_home }}'
    state: 'present'

- name: Create directory for reprepro uploads
  file:
    path: '{{ reprepro_home + "/incoming" }}'
    state: 'directory'
    owner: '{{ reprepro_user }}'
    group: 'www-data'
    mode: '0730'

- name: Create reprepro internal directories
  file:
    path: '{{ reprepro_home + "/" + item }}'
    state: 'directory'
    owner: '{{ reprepro_user }}'
    group: '{{ reprepro_group }}'
    mode: '0755'
  with_items: [ 'conf', 'tmp' ]

- name: Create reprepro repository
  file:
    path: '{{ reprepro_repository_path + "/" + reprepro_distribution | lower }}'
    state: 'directory'
    owner: '{{ reprepro_user }}'
    group: '{{ reprepro_group }}'
    mode: '0755'

- name: Manage reprepro configuration files
  template:
    src: 'var/lib/reprepro/conf/{{ item }}.j2'
    dest: '{{ reprepro_home + "/conf/" + item }}'
    owner: '{{ reprepro_user }}'
    group: '{{ reprepro_group }}'
    mode: '0644'
  with_items: [ 'distributions', 'incoming', 'options', 'pulls', 'updates' ]

- name: Configure uploaders configuration files
  template:
    src: 'var/lib/reprepro/conf/uploaders.j2'
    dest: '{{ reprepro_home + "/conf/" + item.Filename }}'
    owner: '{{ reprepro_user }}'
    group: '{{ reprepro_group }}'
    mode: '0644'
  with_items: reprepro_uploaders

- name: Manage reprepro scripts
  template:
    src: 'var/lib/reprepro/conf/{{ item }}.j2'
    dest: '{{ reprepro_home + "/conf/" + item }}'
    owner: '{{ reprepro_user }}'
    group: '{{ reprepro_group }}'
    mode: '0755'
  with_items: [ 'email-changes.sh' ]

