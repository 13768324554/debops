---

- name: Generate certificate templates
  template:
    src: '{{ "etc/pki/realm/templates/" + (item.0.library | default(pki_library)) + "/" + (item.1.template | default("default")) + ".cnf.j2" }}'
    dest: '{{ pki_base_path + "/" + item.1.realm + "/templates/" + (item.1.filename | default(item.1.cn)) + ".cnf" }}'
    owner: '{{ pki_owner }}'
    group: '{{ pki_public_group }}'
    mode: '{{ pki_public_mode }}'
  with_nested:
    - pki_realms
    - pki_certificates
  when: ((item.1.realm is defined and item.1.realm) and (item.0.dest is defined and item.0.dest) and
         (item.0.dest == item.1.realm) and item.1.cn is defined and
         (item.0.requests is undefined or (item.0.requests is defined and item.0.requests)))

- name: Execute remote hosts Makefiles (may take some time)
  environment:
    LANG: 'C'
  command: make --silent --no-print-directory all chdir={{ pki_base_path }}
  register: pki_register_make
  changed_when: pki_register_make.stdout is defined and pki_register_make.stdout

- name: Upload Certificate Signing Requests
  fetch:
    src: '{{ pki_base_path + "/" + item.0.dest + "/requests/" + (item.1.filename | default(item.1.cn)) + ".csr" }}'
    dest: '{{ pki_base_src + "/realms/" + item.0.src + "/requests/" + (item.1.filename | default(item.1.cn)) + ".csr" }}'
    flat: True
  with_nested:
    - pki_realms
    - pki_certificates
  when: ((item.1.realm is defined and item.1.realm) and (item.0.dest is defined and item.0.dest) and
         (item.0.dest == item.1.realm) and item.1.cn is defined and
         (item.0.requests is undefined or (item.0.requests is defined and item.0.requests)))

- name: Execute source Makefiles
  environment:
    LANG: 'C'
  command: ./make.sh chdir={{ pki_base_src }}
  sudo: False
  delegate_to: 'localhost'
  register: pki_register_make
  changed_when: pki_register_make.stdout is defined and pki_register_make.stdout

- name: Download private files
  copy:
    src: '{{ pki_base_src + "/realms/" + item.0.src + "/" + item.1 + "/" }}'
    dest: '{{ pki_base_path + "/" + item.0.dest + "/" + item.1 + "/" }}'
    owner: '{{ pki_owner }}'
    group: '{{ pki_private_group }}'
    mode: '{{ pki_private_mode }}'
  with_nested:
    - pki_realms
    - [ 'private' ]
  when: (item.0.src is defined and (item.0.dest is defined and item.0.dest) and
         (item.1 is defined and item.1))

- name: Download public files
  copy:
    src: '{{ pki_base_src + "/realms/" + item.0.src + "/" + item.1 + "/" }}'
    dest: '{{ pki_base_path + "/" + item.0.dest + "/" + item.1 }}'
    owner: '{{ pki_owner }}'
    group: '{{ pki_public_group }}'
    mode: '{{ pki_public_mode }}'
  with_nested:
    - pki_realms
    - [ 'CA', 'revoked', 'certs' ]
  when: (item.0.src is defined and (item.0.dest is defined and item.0.dest))

- name: Execute PKI Makefiles
  environment:
    LANG: 'C'
  command: make --silent --no-print-directory all snapshot chdir={{ pki_base_path }}
  register: pki_register_make
  changed_when: pki_register_make.stdout is defined and pki_register_make.stdout

