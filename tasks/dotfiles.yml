---

- name: Get users dotfiles from git repository
  become_user: '{{ item.name }}'
  git:
    repo: '{{ item.dotfiles_repo | default(users__dotfiles[users__default_dotfiles_key].repo) }}'
    dest: '{{ item.dotfiles_dest | default("~/.config/dotfiles") }}'
    update: True
  with_flattened:
    - '{{ users__root_accounts }}'
    - '{{ users__default_accounts }}'
    - '{{ users__admin_accounts }}'
    - '{{ users__accounts }}'
    - '{{ users__group_accounts }}'
    - '{{ users__host_accounts }}'
    - '{{ users_root       | d([]) }}'
    - '{{ users_default    | d([]) }}'
    - '{{ users_admins     | d([]) }}'
    - '{{ users_list       | d([]) }}'
    - '{{ users_group_list | d([]) }}'
    - '{{ users_host_list  | d([]) }}'
  when: ((item.name is defined and item.name) and
         (item.state|d('present') != 'absent') and
         item.createhome|d(True) and
         ((item.dotfiles is defined and item.dotfiles) or
          (users__default_dotfiles is defined and users__default_dotfiles)))

- name: Configure users dotfiles
  become_user: '{{ item.name }}'
  command: '{{ item.dotfiles_command | default(users__dotfiles[users__default_dotfiles_key].command) }}'
  args:
    chdir: '{{ item.dotfiles_dest | default("~/.config/dotfiles") }}'
    creates: '{{item.dotfiles_creates | default(users__dotfiles[users__default_dotfiles_key].creates)}}'
  with_flattened:
    - '{{ users__root_accounts }}'
    - '{{ users__default_accounts }}'
    - '{{ users__admin_accounts }}'
    - '{{ users__accounts }}'
    - '{{ users__group_accounts }}'
    - '{{ users__host_accounts }}'
    - '{{ users_root       | d([]) }}'
    - '{{ users_default    | d([]) }}'
    - '{{ users_admins     | d([]) }}'
    - '{{ users_list       | d([]) }}'
    - '{{ users_group_list | d([]) }}'
    - '{{ users_host_list  | d([]) }}'
  when: ((item.name is defined and item.name) and
         (item.state|d('present') != 'absent') and
         item.createhome|d(True) and
         ((item.dotfiles is defined and item.dotfiles) or
          (users__default_dotfiles is defined and users__default_dotfiles)))

- name: Configure default shell if specified
  user:
    name: '{{ item.name }}'
    shell: '{{ item.shell | default(users__dotfiles[users__default_dotfiles_key].shell | default(omit)) }}'
  with_flattened:
    - '{{ users__root_accounts }}'
    - '{{ users__default_accounts }}'
    - '{{ users__admin_accounts }}'
    - '{{ users__accounts }}'
    - '{{ users__group_accounts }}'
    - '{{ users__host_accounts }}'
    - '{{ users_root       | d([]) }}'
    - '{{ users_default    | d([]) }}'
    - '{{ users_admins     | d([]) }}'
    - '{{ users_list       | d([]) }}'
    - '{{ users_group_list | d([]) }}'
    - '{{ users_host_list  | d([]) }}'
  when: ((item.name is defined and item.name) and
         (item.state|d('present') != 'absent') and
         item.createhome|d(True) and
         ((item.dotfiles is defined and item.dotfiles) or
          (users__default_dotfiles is defined and users__default_dotfiles)))
