---

- name: Override Postfix capabilities if FQDN is not set
  set_fact:
    postfix: [ 'local' ]
  when: ansible_domain is defined and not ansible_domain

- name: Configure aliases database
  template:
    src: 'etc/aliases.j2'
    dest: '/etc/aliases'
    owner: 'root'
    group: 'root'
    mode: '0644'
  notify: [ 'Generate mail alias database' ]

- name: Configure mail system
  template:
    src: '{{ item }}.j2'
    dest: '/{{ item }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  with_items: [ 'etc/mailname' ]

- name: Create Postfix configuration directories
  file:
    path: '/etc/postfix/{{ item }}'
    state: 'directory'
    owner: 'root'
    group: 'root'
    mode: '0755'
  with_items: [ 'tables', 'hash_aliases', 'hash_tables' ]

- name: Create Postfix private configuration directories
  file:
    path: '/etc/postfix/{{ item }}'
    state: 'directory'
    owner: 'root'
    group: 'root'
    mode: '0700'
  with_items: [ 'private_hash_tables' ]

- name: Generate Postfix Makefile
  template:
    src: 'etc/postfix/Makefile.j2'
    dest: '/etc/postfix/Makefile'
    owner: 'root'
    group: 'root'
    mode: '0644'

- name: Generate Postfix configuration
  template:
    src: 'etc/postfix/{{ item }}/ansible.j2'
    dest: '/etc/postfix/{{ item }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  with_items: [ 'main.cf', 'master.cf' ]
  notify: [ 'Check postfix', 'Reload postfix' ]

- name: Generate Postfix scripts
  template:
    src: 'etc/postfix/{{ item }}.j2'
    dest: '/etc/postfix/{{ item }}'
    owner: 'root'
    group: 'root'
    mode: '0755'
  with_items: [ 'postfix-regenerate-dhparams' ]

- name: Generate Postfix DH params
  command: /etc/postfix/postfix-regenerate-dhparams 40 chdir=/etc/postfix creates=/etc/postfix/dh2048.pem
  async: 2400
  poll: 0

- name: Setup DH params regeneration
  cron:
    name: 'Regenerate DH params for postfix'
    minute: '0'
    hour: '{{ postfix_cron_dhparams_hour | default("0") }}'
    user: 'root'
    job: '/etc/postfix/postfix-regenerate-dhparams'
    cron_file: 'postfix-regenerate-dhparams'
    state: 'present'

- name: Generate Postfix tables sources
  template:
    src: '{{ item }}'
    dest: '/etc/postfix/tables/{{ item | basename | replace(".j2", "") }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  with_fileglob: [ '../templates/etc/postfix/tables/*.j2' ]

- name: Generate Postfix hash aliases sources
  template:
    src: '{{ item }}'
    dest: '/etc/postfix/hash_aliases/{{ item | basename | replace(".j2", ".in") }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  with_fileglob: [ '../templates/etc/postfix/hash_aliases/*.j2' ]

- name: Generate Postfix hash tables sources
  template:
    src: '{{ item }}'
    dest: '/etc/postfix/hash_tables/{{ item | basename | replace(".j2", ".in") }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  with_fileglob: [ '../templates/etc/postfix/hash_tables/*.j2' ]

- name: Generate Postfix private hash tables sources
  template:
    src: '{{ item }}'
    dest: '/etc/postfix/private_hash_tables/{{ item | basename | replace(".j2", ".in") }}'
    owner: 'root'
    group: 'root'
    mode: '0600'
  with_fileglob: [ '../templates/etc/postfix/private_hash_tables/*.j2' ]

- name: Run tasks from Postfix Makefile
  environment:
    LANG: 'C'
  command: make chdir=/etc/postfix
  register: postfix_register_make
  changed_when: "not postfix_register_make.stdout.startswith('make: Nothing to be done')"

- name: Configure firewall for Postfix
  template:
    src: 'etc/ferm/filter-input.d/postfix.conf.j2'
    dest: '/etc/ferm/filter-input.d/postfix.conf'
    owner: 'root'
    group: 'adm'
    mode: '0644'
  register: postfix_register_ferm_rules

- name: Restart ferm if firewall rules change
  service:
    name: 'ferm'
    state: 'restarted'
  when: postfix_register_ferm_rules is defined and
        postfix_register_ferm_rules.changed

- name: Restart Postfix if capabilities change
  template:
    src: 'etc/postfix/postfix-capabilities.j2'
    dest: '/etc/postfix/postfix-capabilities'
    owner: 'root'
    group: 'root'
    mode: '0644'
  notify: [ 'Restart postfix' ]

