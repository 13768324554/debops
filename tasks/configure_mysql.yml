---

- name: Install MySQL client if required
  apt:
    name: '{{ item }}'
    state: 'latest'
    install_recommends: 'no'
  with_items: [ 'mysql-client', 'python-mysqldb' ]
  when: 'roundcube_database_map[roundcube_database].dbhost != "localhost"'

- name: Create Roundcube MySQL user
  mysql_user:
    name: '{{ roundcube_database_map[roundcube_database].dbuser }}'
    password: '{{ roundcube_database_map[roundcube_database].dbpass }}'
    state: 'present'
    host: '{% if roundcube_database_map[roundcube_database].dbhost == "localhost" %}localhost{% else %}{{ ansible_fqdn }}{% endif %}'
    priv: '{{ roundcube_database_map[roundcube_database].dbname }}.*:ALL'
  delegate_to: '{% if roundcube_database_map[roundcube_database].dbhost == "localhost" %}{{ inventory_hostname }}{% else %}{{ roundcube_database_map[roundcube_database].dbhost }}{% endif %}'

- name: Create Roundcube database
  mysql_db:
    name: '{{ roundcube_database_map[roundcube_database].dbname }}'
    state: 'present'
  register: roundcube_register_database_status
  delegate_to: '{% if roundcube_database_map[roundcube_database].dbhost == "localhost" %}{{ inventory_hostname }}{% else %}{{ roundcube_database_map[roundcube_database].dbhost }}{% endif %}'

- name: Import initial database schema
  mysql_db:
    name: '{{ roundcube_database_map[roundcube_database].dbname }}'
    state: import
    target: '{{ roundcube_database_schema }}'
    login_user: '{{ roundcube_database_map[roundcube_database].dbuser }}'
    login_password: '{{ roundcube_database_map[roundcube_database].dbpass }}'
    login_host: '{{ roundcube_database_map[roundcube_database].dbhost }}'
  when: roundcube_register_database_status is defined and roundcube_register_database_status.changed
