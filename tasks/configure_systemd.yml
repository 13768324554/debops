---

- name: Generate default systemd units
  template:
    src: 'etc/systemd/system/fcgiwrap.{{ item }}.j2'
    dest: '/etc/systemd/system/fcgiwrap.{{ item }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  with_items: [ 'socket', 'service' ]
  register: fcgiwrap_register_systemd_default
  when: fcgiwrap_disable_default|d(False)

- name: Generate systemd units
  template:
    src: 'etc/systemd/system/fcgiwrap-instance.{{ item.1 }}.j2'
    dest: '/etc/systemd/system/fcgiwrap-{{ item.0.name }}.{{ item.1 }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  register: fcgiwrap_register_systemd
  with_nested:
    - fcgiwrap_instances
    - [ 'socket', 'service' ]
  when: fcgiwrap_instances|d()

- name: Reload systemd units
  command: 'systemctl daemon-reload'
  when: ((fcgiwrap_register_systemd_default|d() and
          fcgiwrap_register_systemd_default.changed) or
         (fcgiwrap_register_systemd|d() and
          fcgiwrap_register_systemd.changed))

- name: Stop default fcgiwrap service
  service:
    name: '{{ item }}'
    state: 'stopped'
    enabled: False
  with_items: [ 'fcgiwrap.service', 'fcgiwrap.socket' ]
  when: fcgiwrap_register_systemd_default|d() and
        fcgiwrap_register_systemd_default.changed

- name: Enable and start systemd units
  service:
    name: 'fcgiwrap-{{ item.0.name }}.{{ item.1 }}'
    state: 'started'
    enabled: True
  with_nested:
    - fcgiwrap_instances
    - [ 'socket', 'service' ]
  when: fcgiwrap_instances|d()

