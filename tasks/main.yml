---

- name: Add upstream PostgreSQL APT key
  apt_key:
    id: '7FCC7D46ACCC4CF8'
    state: 'present'
    keyserver: '{{ ansible_local.core.keyserver
                   if (ansible_local|d() and ansible_local.core|d() and
                       ansible_local.core.keyserver)
                   else "hkp://pool.sks-keyservers.net" }}'
  when: postgresql_upstream|d() and postgresql_upstream

- name: Add upstream PostgreSQL APT repository
  apt_repository:
    repo: 'deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main'
    state: 'present'
    update_cache: True
  when: postgresql_upstream|d() and postgresql_upstream

  set_fact:

- name: Install PostgreSQL packages
  apt:
    name: '{{ item }}'
    state: 'present'
    install_recommends: False
  with_flattened:
    - postgresql_base_packages
    - postgresql_packages

  changed_when: False

