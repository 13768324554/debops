---

- name: Install required packages
  apt:
    name: '{{ item }}'
    state: 'latest'
    install_recommends: False
  with_flattened:
    - [ 'git', 'python-pip' ]
    - debops_base_packages
    - debops_ansible_packages
    - debops_packages
  when: item|d()

- name: Install DebOps from PyPI
  pip:
    name: '{{ item }}'
    state: 'present'
  with_items: debops_pip_packages
  notify: '[ "Update DebOps in the background with {{ debops_update_method }}" ] if debops_update_method is not "sync" else []'
  when: item|d()

- name: Update roles and playbooks
  command: debops-update
  when: debops_install_systemwide|bool and
        debops_update_method == 'sync'

- name: Configure system-wide DebOps scripts
  template:
    src: 'etc/debops.cfg.j2'
    dest: '/etc/debops.cfg'
    owner: 'root'
    group: 'root'
    mode: '0644'

