---

- name: Install required packages
  apt:
    name: '{{ item }}'
    state: 'present'
    install_recommends: False
  register: fcgiwrap_register_install
  with_items: '{{ fcgiwrap_packages }}'

- name: Check the fcgiwrap version
  environment:
    LC_MESSAGES: 'C'
  shell: "dpkg-query -W -f='${Version}\n' 'fcgiwrap'"
  register: fcgiwrap_register_version
  changed_when: False
  failed_when: False

- name: Configure required users and groups
  include: configure_users.yml
  when: fcgiwrap_instances|d()

- name: Disable default fcgiwrap init script
  service:
    name: 'fcgiwrap'
    state: 'stopped'
    enabled: False
  when: fcgiwrap_disable_default|bool and fcgiwrap_register_install.changed|bool

- name: Configure fcgiwrap instances in sysvinit
  include: configure_sysvinit.yml
  when: (ansible_local|d() and ansible_local.init|d() and
          ansible_local.init != 'systemd')

- name: Configure fcgiwrap instances in systemd
  include: configure_systemd.yml
  when: (ansible_local|d() and ansible_local.init|d() and
          ansible_local.init == 'systemd')

