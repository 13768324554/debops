---

- name: Configure NeuroDebian APT repository
  template:
    src: 'etc/apt/sources.list.d/neurodebian.sources.list.j2'
    dest: '/etc/apt/sources.list.d/neurodebian.sources.list'
    owner: 'root'
    group: 'root'
    mode: '0644'
  when: (neurodebian__deploy_state == "present")
  notify: [ 'Update APT repository cache' ]

- name: Ensure the NeuroDebian APT repository is disabled
  file:
    path: '/etc/apt/sources.list.d/neurodebian.sources.list'
    state: 'absent'
  when: (neurodebian__deploy_state == "absent")
  notify: [ 'Update APT repository cache' ]

- name: Ensure NeuroDebian APT OpenPGP public key is in it's desired state
  apt_key:
    id: '{{ neurodebian__apt_key_fingerprint }}'
    keyserver: '{{ ansible_local.core.keyserver
                   if (ansible_local|d() and ansible_local.core|d() and
                       ansible_local.core.keyserver|d())
                   else "hkp://pool.sks-keyservers.net" }}'
    state: '{{ "present" if (neurodebian__deploy_state == "present") else "absent" }}'
  notify: [ 'Update APT repository cache' ]

- meta: flush_handlers

- name: Ensure specified packages are in there desired state
  package:
    name: '{{ item }}'
    state: '{{ "present" if (neurodebian__deploy_state == "present") else "absent" }}'
  with_flattened:
    - '{{ neurodebian__packages }}'
    - '{{ neurodebian__group_packages }}'
    - '{{ neurodebian__host_packages }}'
    - '{{ neurodebian__dependent_packages }}'
  tags: [ 'role::neurodebian:pkgs' ]
