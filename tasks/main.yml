---

- name: Blacklist kernel modules
  kernel_blacklist:
    name: '{{ item.name }}'
    state: '{% if item.blacklist %}present{% else %}absent{% endif %}'
    blacklist_file: '{{ kernel_module_blacklist_file }}'
  when: (
          item is mapping and (
            item.blacklist is defined and
            item.state is undefined
          )
        )
  with_flattened:
    - kernel_module_list
    - kernel_module_group_list
    - kernel_module_host_list

- name: Modprobe kernel modules
  modprobe:
    name: '{{ item.name }}'
    params: '{{ item.params | default(omit) }}'
    state: '{{ item.state }}'
    # blacklist_file: '{{ kernel_module_blacklist_file }}'
  when: (
          item is mapping and (
            item.state is defined and
            item.blacklist is undefined
          )
        )
  with_flattened:
    - kernel_module_list
    - kernel_module_group_list
    - kernel_module_host_list

- name: Ensure that kernel module are automaticly loaded
  template:
    src: 'load_module.conf.conf.j2'
    dest: '{{ kernel_module_load_file }}'

- name: Ensure that module parameters are honored
  template:
    src: 'modprobe_options.conf.j2'
    dest: '{{ kernel_module_options_file }}'
