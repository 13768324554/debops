---

- name: Install required packages
  apt:
    name: '{{ item }}'
    state: 'latest'
    install_recommends: False
  with_flattened:
    - [ 'git', 'python-pip' ]
    - debops_packages

- name: Clone main DebOps source code
  git:
    repo: '{{ debops_source_url }}'
    dest: '{{ debops_source_path }}'
    version: '{{ debops_source_version }}'
    update: True
  register: debops_register_source

- name: Install DebOps playbooks and roles
  command: pip install {{ debops_source_path }}
  when: debops_register_source.changed

- name: Install DebOps playbooks and roles (async)
  command: debops-update
  async: '{{ (60 * 5) | int }}'
  poll: 0
  when: debops_playbooks_systemwide

