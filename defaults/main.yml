---

# ---- Language and localization ----

# Responses for Debconf questions, need to be the same format as in Debconf.
# To see available responses, run 'dpkg-reconfigure mailman'
mailman_debconf_languages: [ 'en (English)' ]
mailman_debconf_default_language: 'en (English)'

# Default language used on this Mailman host
mailman_default_language: 'en'

# List of languages (as two-letter names spearated by spaces) to convert to
# UTF-8 charset using 'convert-mailman-to-utf8' script. If you have primarily
# English site, you don't need to mess with that. :-)
mailman_convert_languages: []


# --- Site configuration ----

# List of "virtual domains" recognized by Mailman. The first domain on the list
# will be a default domain. If this list is empty, Mailman will use ansible_fqdn
# as it's default domain (requires 'local' capability in postfix).
mailman_domains: [ 'lists.{{ ansible_domain }}' ]

# Site administrator e-mail address
mailman_site_admin: 'listmaster@{{ ansible_domain }}'

# Postmaster address, required by 'postfix-to-mailman.py' script
mailman_site_postmaster: 'postmaster@{{ ansible_domain }}'

# Maximum message size enforced by Mailman by default, in kilobytes. Can be
# changed for each list independently in the web interface
mailman_max_message_size: '100'

# Maximum number of recipients in each SMTP session
mailman_smtp_max_recipients: '500'

# Default mailing list, usually 'mailman'
mailman_site_list: 'mailman'


# ---- Web interface and archives ----

# List of hosts or CIDR networks to allow access to Mailman web interface. If
# the list is empty, allow access from all hosts/networks
mailman_allow: []

# Should Mailman offer .mbox file in public list archives?
mailman_public_mbox: True


# ---- Passwords ----

# Length of generated passwords for site administrator and list creator access
mailman_site_password_length: '40'

# Length of generated passwords for mailing list owner/admin access
mailman_admin_password_length: '30'

# Length of generated passwords for list members
mailman_member_password_length: '20'

# Should Mailman generate user-friendly passwords?
mailman_user_friendly_passwords: 'No'


# ---- Spam and backscatter prevention ----

# Should auto-discarded messages from non-members be automatically sent to list
# moderators/admins? Setting this to No will reduce spammy messages to moderators
mailman_default_forward_auto_discards: 'No'

# How much of the original message should be included in auto-responses?
mailman_response_include_level: '0'

# What should be done with mail messages from non-members by default? 3 = Discard
mailman_default_generic_nonmember_action: '3'

# List of domains allowed as referers
mailman_referers: '{{ (mailman_domains + [ ansible_fqdn, "*." + ansible_domain ]) }}'


# ---- Other options ----

# Additional Mailman options in a text block format
# You can find more options in /usr/lib/mailman/Mailman/Defaults.py
mailman_options: False

# List of mailing lists to create or remove
mailman_lists: []

  #- name: 'mailing-list'                       # mailing list name, required
  #  domain: 'example.com'                      # specify different domain than the main one
  #  owner: 'root@{{ ansible_domain }}'         # list owner email address
  #  state: 'present,absent'
  #  language: 'en'                             # default list language
  #  purge: False,True                          # remove list archives when deleting?


# -------------------------------
#   Mailman source code patches
# -------------------------------

# .. envvar:: mailman_patch
#
# Enable or disable patching of the Mailman source code.
mailman_patch: True


# .. envvar:: mailman_patch_list
#
# List of patches applied to Mailman source code.
mailman_patch_list:

  # Add direct link to moderation page
  - 'add-moderator-link'

  # Remove automatic capitalization of list names
  - 'remove-upper-list-name'

  # Ignore commands from non-members (reduces backscatter, but blocks mail
  # registration)
  - 'ignore-commands-from-nonmembers'

  # Remove extra aliases that are not needed (reduces backscatter)
  - 'prune-alias-list'


# -----------------------------------------
#   Configuration for other Ansible roles
# -----------------------------------------

# .. envvar:: mailman__fcgiwrap__instance
#
# Configure ``fcgiwrap`` instance for Mailman using ``debops.fcgiwrap`` role.
mailman__fcgiwrap__instance:
  name: 'mailman'
  user: 'list'
  group: 'list'


# .. envvar:: mailman__postfix__dependent_lists
#
# Configuration of Postfix list variables in ``debops.postfix`` role.
mailman__postfix__dependent_lists:
  alias_maps:
    - capability: 'local'
      list: [ 'hash:/var/lib/mailman/data/aliases' ]
  relay_domains:
    - no_capability: 'local'
      list: '{{ mailman_domains }}'
  relay_recipient_maps:
    - no_capability: 'local'
      list: [ 'hash:/var/lib/mailman/data/virtual-mailman' ]
  transport_maps:
    - no_capability: 'local'
      list: [ 'hash:/etc/mailman/postfix_transport' ]
  virtual_alias_domains:
    - capability: 'local'
      list: '{{ mailman_domains }}'
  virtual_alias_maps:
    - capability: 'local'
      list: [ 'hash:/var/lib/mailman/data/virtual-mailman' ]


# .. envvar:: mailman__postfix__dependent_maincf
#
# Configuration of Postfix ``main.cf`` in ``debops.postfix`` role.
mailman__postfix__dependent_maincf:
  - param: 'mailman_destination_recipient_limit'
    value: '1'
    no_capability: 'local'


# .. envvar:: mailman__postfix__dependent_mastercf
#
# Configuration of Postfix ``master.cf`` in ``debops.postfix`` role.
mailman__postfix__dependent_mastercf:
  - service: 'mailman'
    type: 'unix'
    unpriv: 'n'
    chroot: 'n'
    command: 'pipe'
    options: |
      flags=FR user=list
      argv=/var/lib/mailman/bin/postfix-to-mailman.py ${nexthop} ${user}
    no_capability: 'local'


# .. envvar:: mailman__nginx__servers
#
# Configuration of ``nginx`` server to access Mailman web interface, using
# ``debops.nginx`` Ansible role.
mailman__nginx__servers:
  - by_role: 'debops.mailman'
    enabled: True
    name: '{{ mailman_domains }}'
    filename: 'debops.mailman'
    root: '/usr/lib/cgi-bin/mailman'

    location:

      '~ ^/(mailman/?)?$': |
        rewrite ^ /mailman/listinfo permanent;

      '~ ^/mailman/.': |
        gzip off;
        root /usr/lib/cgi-bin/mailman;
        fastcgi_split_path_info       ^/mailman(/[^/]*)(.*)$;
        include       fastcgi_params;
        fastcgi_param PATH_INFO       $fastcgi_path_info;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
        fastcgi_param SCRIPT_FILENAME  /usr/lib/cgi-bin/mailman$fastcgi_script_name;
        fastcgi_pass  unix:/run/fcgiwrap-mailman.socket;

      '/images/mailman': |
        alias /var/lib/mailman/icons;

      '/pipermail': |
        alias /var/lib/mailman/archives/public;
        autoindex on;

    location_allow:
      '~ ^/mailman/.':   '{{ mailman_allow }}'
      '/images/mailman': '{{ mailman_allow }}'
      '/pipermail':      '{{ mailman_allow }}'

    location_referers:
      '~ ^/mailman/.': '{{ mailman_referers }}'

