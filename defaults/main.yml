---

# List of PHP Debian packages in order of preference
php__version_preference: [ 'php7.0', 'php5' ]

# Enable Ondřej Surý APT repositories
php__sury: False

php__sury_apt_key_id: '{{ php__sury_apt_key_id_map[ansible_distribution] }}'

php__sury_apt_repo: '{{ php__sury_apt_repo_map[ansible_distribution] }}'

php__sury_apt_key_id_map:
  'Debian': 'DF3D585DB8F0EB658690A554AC0E47584A7A714D'
  'Ubuntu': '14AA40EC0831756756D7F66C4F4EA0AAE5267A6C'

php__sury_apt_repo_map:
  'Debian': 'deb https://packages.sury.org/php/ {{ ansible_distribution_release }} main'
  'Ubuntu': 'ppa:ondrej/php'


# Settings for socket permissions
# Sockets have to be accessible by a webserver
php__socket_listen_owner: 'www-data'
php__socket_listen_group: 'www-data'
php__socket_listen_mode: '0660'

php__server_api_packages: [ 'cli', 'fpm' ]

# Install set of standard packages.
#
# Prefix is automatically added later to match php__version (php5- or php7.0-).
# If you force a prefix it will be respected (ie. for php-pear or php-soap).
php__base_packages: [ 'curl', 'gd', 'mcrypt' ]

# .. envvar:: php__packages
#
# List of additional "global" packages to install.
#
# Prefix is automatically added later to match php__version (php5- or php7.0-).
# If you force a prefix it will be respected (ie. for php-pear or php-soap).
php__packages: []

# .. envvar:: php__group_packages
#
# List of packages for a group of hosts (only one group supported).
#
# Prefix is automatically added later to match php__version (php5- or php7.0-).
# If you force a prefix it will be respected (ie. for php-pear or php-soap).
php__group_packages: []

# .. envvar:: php__host_packages
#
# List of packages to install on a given host.
#
# Prefix is automatically added later to match php__version (php5- or php7.0-).
# If you force a prefix it will be respected (ie. for php-pear or php-soap).
php__host_packages: []

php__dependent_packages: []

# This variable determines what options will be used in php.ini for options
# that can be useful either in production or development environment
php__production: True

# Default values for several global PHP5 options
php__ini_cgi_fix_pathinfo: False

php__ini_max_execution_time: '30'

php__ini_max_input_time: '60'

php__ini_memory_limit: '128M'

php__ini_post_max_size: '8M'

php__ini_default_charset: 'UTF-8'

php__ini_file_uploads: True

php__ini_upload_max_filesize: '{{ php__ini_post_max_size }}'

php__ini_max_file_uploads: '20'

php__ini_allow_url_fopen: True

php__ini_date_timezone: '{{ ansible_local.timezone
                            if (ansible_local|d() and ansible_local.timezone|d())
                            else "Etc/UTC" }}'

# Default values used in pools when pool has none set
php__default_pm: 'ondemand'
php__default_pm_max_children: 5
php__default_pm_min_spare_servers: 1
php__default_pm_max_spare_servers: 3
php__default_pm_start_servers: 2
php__default_pm_process_idle_timeout: '10s'
php__default_pm_max_requests: 500
php__default_pm_status: False
php__default_pm_status_path: '/php_status'
php__default_ping_path: '/php_ping'
php__default_ping_response: 'pong'
php__default_rlimit_files: 1024
php__default_rlimit_core: 0

# Custom ``php.ini`` configuration managed by Ansible. See
# :ref:`php__ref_configuration` for more details.
php__default_configuration:

  - filename: '00-ansible'
    name: 'PHP'
    sections:

      - options: |
          max_execution_time =     {{  php__ini_max_execution_time }}
          max_input_time =         {{  php__ini_max_input_time }}
          memory_limit =           {{  php__ini_memory_limit }}
          error_reporting =        {{ (php__production|bool)|ternary('E_ALL & ~E_DEPRECATED & ~E_STRICT', 'E_ALL') }}
          display_errors =         {{ (php__production|bool)|ternary('Off', 'On') }}
          display_startup_errors = {{ (php__production|bool)|ternary('Off', 'On') }}
          track_errors =           {{ (php__production|bool)|ternary('Off', 'On') }}
          post_max_size =          {{  php__ini_post_max_size }}
          default_charset =        {{  php__ini_default_charset }}
          file_uploads =           {{ (php__ini_file_uploads|bool)|ternary('On', 'Off') }}
          upload_max_filesize =    {{  php__ini_upload_max_filesize }}
          max_file_uploads =       {{  php__ini_max_file_uploads }}
          allow_url_fopen =        {{ (php__ini_allow_url_fopen|bool)|ternary('On','Off') }}

      - name: 'CGI'
        options: |
          cgi.fix_pathinfo =       {{ (php__ini_cgi_fix_pathinfo|bool)|ternary('1','0') }}

      - name: 'Date'
        options: |
          date.timezone =          {{ php__ini_date_timezone }}

php__configuration: []

php__group_configuration: []

php__host_configuration: []

# List of managed pools
php__default_pools: [ '{{ php__pool_www_data }}' ]

php__pools: []

php__group_pools: []

php__host_pools: []

php__dependent_pools: []

# Default PHP-FPM pool for www-data, explanation of variables can be found
# in templates/etc/php/fpm/pool-available.d/pool.conf.j2
# Everything commented out is optional.
php__pool_www_data:
  enabled: True
  name: 'www-data'

  #prefix: ''

  #user: 'www-data'
  #group: 'www-data'

  #listen: '/var/run/php5-fpm-www-data.sock'

  # pm: static, dynamic, ondemand
  #pm: 'ondemand'

  # Settings for all management types
  #pm_max_children: 5

  # Settings for 'dynamic' process management
  #pm_min_spare_servers: 1
  #pm_max_spare_servers: 3
  #pm_start_servers: 2

  # Settings for 'ondemand' process management
  #pm_process_idle_timeout: '30s'

  #pm_max_requests: 500

  #pm_status: True
  #pm_status_path: '{{ php__default_pm_status_path }}'
  #ping_path: '{{ php__default_ping_path }}'
  #ping_response: '{{ php__default_ping_response }}'

  #accesslog: True

  #request_slowlog_timeout: '30s'

  #request_terminate_timeout: '5m'

  #rlimit_files: 1024
  #rlimit_core: 0

  #chroot: ''
  #chdir: '/'

  #catch_workers_output: False

  #security_limit_extensions: '.php'

  #environment:
  #  HOSTNAME: '$HOSTNAME'
  #  PATH: '/usr/local/bin:/usr/bin:/bin'
  #  TMP: '/tmp'
  #  TMPDIR: '/tmp'
  #  TEMP: '/tmp'

  #php_flag:
  #  display_errors: 'off'

  #php_value:
  #  default_mimetype: 'text/html'

  #php_admin_flag:
  #  log_errors: 'on'

  #php_admin_value:
  #  memory_limit: '32M'

  #open_basedir: '/usr/share/php5:/tmp'


# .. Configuration of other Ansible roles [[[1
#
# ----------------------------------------
#   Configuration of other Ansible roles
# ----------------------------------------

# .. envvar:: php__logrotate__dependent_config
#
# Configuration of the ``debops.logrotate`` role.
php__logrotate__dependent_config:

  - filename: 'php{{ php__version }}-fpm'
    divert: True
    logs:
      - '/var/log/php{{ php__version }}-fpm.log'
      - '/var/log/php{{ php__version }}-fpm/*.log'
    options: |
      rotate 12
      missingok
      weekly
      notifempty
      compress
      delaycompress
    postrotate: |
      {% if php__long_version | version_compare("5.5","<") %}
      invoke-rc.d php{{ php__version }}-fpm reopen-logs > /dev/null
      {% else %}
      {{ php__logrotate_lib_base }}/php{{ php__version }}-fpm-reopenlogs
      {% endif %}

