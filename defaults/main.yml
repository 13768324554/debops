---

# Enable or disable PKI support
pki: True


# ---- Default DN for Certificate Requests ----

pki_country:             'QS'
pki_state:               'Q-Space'
pki_locality:            'Global'
pki_organization:        '{{ ansible_domain.split(".")[0] | capitalize }}'
pki_organizational_unit: 'Data Center Operations'
pki_common_name:         '{{ ansible_fqdn }}'
pki_email:               'root@{{ ansible_domain }}'


# ---- PKI main options ----

# List of additional packages to install ('haveged' might be useful for faster
# randomness in testing environment)
pki_packages: []

# Base PKI directory on remote hosts
pki_base_path: '/etc/pki'

# Base PKI directory on Ansible Controller
# See debops.secret role for more information
pki_base_src: '{{ secret + "/pki/" + ansible_domain }}'

# Directory and file permissions for public and private data
pki_owner: 'root'
pki_public_group: 'root'
pki_private_group: 'ssl-cert'
pki_private_group_create: False
pki_private_group_system: True
pki_public_dir_mode: '0755'
pki_private_dir_mode: '2750'
pki_public_mode: '0644'
pki_private_mode: '0640'


# ---- Certificate defaults ----

# Default digest engine to use for signatures
pki_digest: 'sha256'

# Default key size
pki_private_key_size: '2048'

# Base sign period for "normal" certificates
pki_sign_days: '365'

# Base multiplier for Root CA - 10 years
pki_sign_rootca_multiplier: '10'

# Base multiplier for intermediate CA - 5 years
pki_sign_ca_multiplier: '5'

# Base multiplier for certificate - 1 year
pki_sign_cert_multiplier: '1'


pki_rootca: 'RootCA'
pki_rootca_filename: '{{ pki_rootca + "-" + ansible_domain }}'
pki_rootca_private_key_size: '4096'
pki_rootca_o: '{{ pki_organization + " Certificate Authority" }}'
pki_rootca_cn: '{{ pki_organization + " Root Certificate" }}'

pki_parent_ca: 'ParentCA'

pki_snapshot: True
pki_snapshot_path: '/var/backups'
pki_snapshot_file: '{{ "pki-snapshot-" + ansible_fqdn + ".tar" }}'
pki_snapshot_owner: 'root'
pki_snapshot_group: 'root'

pki_library: 'openssl'

pki_default_ca: '/etc/ssl/certs/ca-certificates.crt'
pki_default_cn: '{{ ansible_fqdn }}'

pki_default_realm: 'host'

pki_default_host_certificate: '{{ ansible_fqdn }}'
pki_default_domain_certificate: '{{ "wildcard.domain." + ansible_fqdn }}'

pki_realms:

  - source: 'domain'
    destination: 'domain'
    ca: [ 'RootCA' ]
    makefile: False

  - source: 'hosts/{{ ansible_fqdn }}/domain'
    destination: 'domain'
    authority: 'domain'
    default: '{{ pki_default_domain_certificate }}'

  - source: 'hosts/{{ ansible_fqdn }}/host'
    destination: 'host'
    authority: 'internal'
    default: '{{ pki_default_host_certificate }}'

pki_authorities:

  - name: 'RootCA'
    grants: 'ca'
    private_key_size: '{{ pki_rootca_private_key_size }}'
    filename: '{{ pki_rootca_filename }}'
    default_dn: False
    o: '{{ pki_rootca_o }}'
    cn: '{{ pki_rootca_cn }}'

  - name: 'DomainCA'
    grants: 'ca'
    parent: 'RootCA'
    o: '{{ pki_rootca_o }}'
    ou: '{{ pki_organization + " CA" }}'
    cn: '{{ "ca." + ansible_domain }}'

  - name: 'internal'
    parent: 'DomainCA'
    ou: '{{ pki_organization + " Data Center" }}'
    cn: '{{ "dc." + ansible_domain }}'

  - name: 'domain'
    grants: 'server'
    parent: 'DomainCA'
    ou: '{{ pki_organizational_unit }}'
    cn: '{{ "dco." + ansible_domain }}'


pki_routes:

  - name: 'host_{{ ansible_fqdn }}'
    authority: 'internal/certs'
    realm: 'hosts/{{ ansible_fqdn }}/host/certs'
    file: '{{ ansible_fqdn }}.crt'

  - name: 'domain_{{ ansible_fqdn }}'
    authority: 'domain/certs'
    realm: 'hosts/{{ ansible_fqdn }}/domain/certs'
    file: 'wildcard.domain.{{ ansible_fqdn }}.crt'

  - name: 'root_ca'
    authority: 'RootCA'
    realm: 'domain/CA'
    readlink: 'CA.crt'


pki_certificates:

  - source: '{{ "hosts/" + ansible_fqdn + "/host" }}'
    destination: 'host'
    ou: '{{ pki_organization + " Data Center" }}'
    cn: '{{ ansible_fqdn }}'
    dns: [ '{{ "*." + ansible_domain }}' ]
    ip: '{{ (ansible_all_ipv4_addresses + ansible_all_ipv6_addresses | ipaddr("public")) }}'

  - source: '{{ "hosts/" + ansible_fqdn + "/domain" }}'
    destination: 'domain'
    ou: '{{ pki_organizational_unit }}'
    cn: '{{ ansible_domain }}'
    dns: [ '{{ "*." + ansible_domain }}' ]
    filename: 'wildcard.domain.{{ ansible_fqdn }}'


# Example list of certificate options
#  - realm: 'host'
#    cn:    'www.example.com'
#    mail:  [ 'root@example.com' ]
#    dns:   [ 'www.example.com', 'mail.example.com', '*.mail.example.com' ]
#    uri:   [ 'http://example.com/' ]
#    ip:    [ '192.0.2.1' ]
#
#  - realm: 'host'
#    cn:    'subdomain.{{ ansible_domain }}'
#
#  - realm: 'host'
#    cn:    '{{ "other." + ansible_domain }}'
#    ou:    'Other Department'
#    e:     '{{ "root@other." + ansible_domain }}'
#    mail:  [ '{{ "others@other." + ansible_domain }}', '{{ "root@" + ansible_domain }}' ]
#    dns:   [ '{{ "*.other." + ansible_domain }}' ]

