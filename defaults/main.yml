---
# Default variables
# =================

# .. contents:: Sections
#    :local:
#
# -----------------------------
#   Packages and installation
# -----------------------------

# .. envvar:: mailman_packages
#
# List of APT packages to install.
mailman_packages: [ 'mailman', 'gettext', 'patch' ]


# -----------------------------
#   Language and localization
# -----------------------------

# .. envvar:: mailman__default_languages
#
# List of default language packs enabled in Mailman, specified as two letter
# names. First element is used as the site language.
mailman__default_languages: [ 'en' ]


# .. envvar:: mailman__languages
#
# List of additional language packs to enable in Mailman, specified as two
# letter names.
mailman__languages: []


# .. envvar:: mailman__site_language
#
# Default language used for new mailing lists and in the web interface.
mailman__site_language: '{{ mailman__default_languages[0] }}'


# ------------------------
#   Mailing list domains
# ------------------------

# .. envvar:: mailman__fqdn
#
# A fully qualified domain name of the host that manages the mailing lists.
mailman__fqdn: '{{ ansible_fqdn }}'


# .. envvar:: mailman__domain
#
# A DNS domain name of the host that manages the default mailing lists.
mailman__domain: '{{ ansible_domain if ansible_domain else ansible_hostname }}'


# .. envvar:: mailman__site_domain
#
# The primary domain used by the Mailing List Manager to serve its Web
# interface and host the default mailing lists.
mailman__site_domain: '{{ ("lists." + mailman__domain) }}'


# .. envvar:: mailman__virtual_domains
#
# List of additional virtual domains which are used by Mailman.
mailman__virtual_domains: []


# Site administrator e-mail address
mailman_site_admin: 'listmaster@{{ mailman__domain }}'

# Postmaster address, required by 'postfix-to-mailman.py' script
mailman_site_postmaster: 'postmaster@{{ mailman__domain }}'

# Maximum message size enforced by Mailman by default, in kilobytes. Can be
# changed for each list independently in the web interface
mailman_max_message_size: '100'

# Maximum number of recipients in each SMTP session
mailman_smtp_max_recipients: '500'

# Default mailing list, usually 'mailman'
mailman_site_list: 'mailman'


# ---- Web interface and archives ----

# List of hosts or CIDR networks to allow access to Mailman web interface. If
# the list is empty, allow access from all hosts/networks
mailman_allow: []

# Should Mailman offer .mbox file in public list archives?
mailman_public_mbox: True


# ---- Passwords ----

# Length of generated passwords for site administrator and list creator access
mailman_site_password_length: '40'

# Length of generated passwords for mailing list owner/admin access
mailman_admin_password_length: '30'

# Length of generated passwords for list members
mailman_member_password_length: '20'

# Should Mailman generate user-friendly passwords?
mailman_user_friendly_passwords: 'No'


# ---- Spam and backscatter prevention ----

# Should auto-discarded messages from non-members be automatically sent to list
# moderators/admins? Setting this to No will reduce spammy messages to moderators
mailman_default_forward_auto_discards: 'No'

# How much of the original message should be included in auto-responses?
mailman_response_include_level: '0'

# What should be done with mail messages from non-members by default? 3 = Discard
mailman_default_generic_nonmember_action: '3'

# List of domains allowed as referers
mailman_referers: '{{ ([ mailman__site_domain ] + mailman__virtual_domains + [ mailman__fqdn, "*." + mailman__domain ]) }}'


# ---- Other options ----

# Additional Mailman options in a text block format
# You can find more options in /usr/lib/mailman/Mailman/Defaults.py
mailman_options: False

# List of mailing lists to create or remove
mailman_lists: []

  #- name: 'mailing-list'                       # mailing list name, required
  #  domain: 'example.com'                      # specify different domain than the main one
  #  owner: 'root@{{ ansible_domain }}'         # list owner email address
  #  state: 'present,absent'
  #  language: 'en'                             # default list language
  #  purge: False,True                          # remove list archives when deleting?


# -------------------------------
#   Mailman source code patches
# -------------------------------

# .. envvar:: mailman_patch
#
# Enable or disable patching of the Mailman source code.
mailman_patch: True


# .. envvar:: mailman_patch_list
#
# List of patches applied to Mailman source code.
mailman_patch_list:

  # Add direct link to moderation page
  - 'add-moderator-link'

  # Remove automatic capitalization of list names
  - 'remove-upper-list-name'

  # Ignore commands from non-members (reduces backscatter, but blocks mail
  # registration)
  - 'ignore-commands-from-nonmembers'

  # Remove extra aliases that are not needed (reduces backscatter)
  - 'prune-alias-list'


# -----------------------------------------
#   Configuration for other Ansible roles
# -----------------------------------------

# .. envvar:: mailman__fcgiwrap__instance
#
# Configure ``fcgiwrap`` instance for Mailman using ``debops.fcgiwrap`` role.
mailman__fcgiwrap__instance:
  name: 'mailman'
  user: 'list'
  group: 'list'


# .. envvar:: mailman__postfix__dependent_lists
#
# Configuration of Postfix list variables in ``debops.postfix`` role.
mailman__postfix__dependent_lists:
  alias_maps:
    - capability: 'local'
      list: [ 'hash:/var/lib/mailman/data/aliases' ]
  relay_domains:
    - no_capability: 'local'
      list: '{{ [ mailman__site_domain ] + mailman__virtual_domains }}'
  relay_recipient_maps:
    - no_capability: 'local'
      list: [ 'hash:/var/lib/mailman/data/virtual-mailman' ]
  transport_maps:
    - no_capability: 'local'
      list: [ 'hash:/etc/mailman/postfix_transport' ]
  virtual_alias_domains:
    - capability: 'local'
      list: '{{ [ mailman__site_domain ] + mailman__virtual_domains }}'
  virtual_alias_maps:
    - capability: 'local'
      list: [ 'hash:/var/lib/mailman/data/virtual-mailman' ]


# .. envvar:: mailman__postfix__dependent_maincf
#
# Configuration of Postfix ``main.cf`` in ``debops.postfix`` role.
mailman__postfix__dependent_maincf:
  - param: 'mailman_destination_recipient_limit'
    value: '1'
    no_capability: 'local'


# .. envvar:: mailman__postfix__dependent_mastercf
#
# Configuration of Postfix ``master.cf`` in ``debops.postfix`` role.
mailman__postfix__dependent_mastercf:
  - service: 'mailman'
    type: 'unix'
    unpriv: 'n'
    chroot: 'n'
    command: 'pipe'
    options: |
      flags=FR user=list
      argv=/var/lib/mailman/bin/postfix-to-mailman.py ${nexthop} ${user}
    no_capability: 'local'


# .. envvar:: mailman__nginx__servers
#
# Configuration of ``nginx`` server to access Mailman web interface, using
# ``debops.nginx`` Ansible role.
mailman__nginx__servers:
  - by_role: 'debops.mailman'
    enabled: True
    name: '{{ [ mailman__site_domain ] + mailman__virtual_domains }}'
    filename: 'debops.mailman'
    root: '/usr/lib/cgi-bin/mailman'

    location:

      '~ ^/(mailman/?)?$': |
        rewrite ^ /mailman/listinfo permanent;

      '~ ^/mailman/.': |
        gzip off;
        root /usr/lib/cgi-bin/mailman;
        fastcgi_split_path_info       ^/mailman(/[^/]*)(.*)$;
        include       fastcgi_params;
        fastcgi_param PATH_INFO       $fastcgi_path_info;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
        fastcgi_param SCRIPT_FILENAME  /usr/lib/cgi-bin/mailman$fastcgi_script_name;
        fastcgi_pass  unix:/run/fcgiwrap-mailman.socket;

      '/images/mailman': |
        alias /var/lib/mailman/icons;

      '/pipermail': |
        alias /var/lib/mailman/archives/public;
        autoindex on;

    location_allow:
      '~ ^/mailman/.':   '{{ mailman_allow }}'
      '/images/mailman': '{{ mailman_allow }}'
      '/pipermail':      '{{ mailman_allow }}'

    location_referers:
      '~ ^/mailman/.': '{{ mailman_referers }}'

