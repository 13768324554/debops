---
# .. vim: foldmarker=[[[,]]]:foldmethod=marker

# debops.dokuwiki default variables [[[
# =====================================

# .. contents:: Sections
#    :local:


# Basic configuration options [[[
# -------------------------------

# .. envvar:: dokuwiki_main_domain [[[
#
# Default domain which will be used to host the "main" wiki instance.
dokuwiki_main_domain: 'wiki.{{ ansible_domain }}'

                                                                   # ]]]
# .. envvar:: dokuwiki_domains [[[
#
# List of domains on which DokuWiki is configured in ``nginx``.
dokuwiki_domains: '{{ [ dokuwiki_main_domain ] +
                      dokuwiki_farm_animals|d([]) }}'

                                                                   # ]]]
# .. envvar:: dokuwiki_nginx_auth_realm [[[
#
# Basic Auth realm displayed in the login dialog.
dokuwiki_nginx_auth_realm: 'Wiki access is restricted'

                                                                   # ]]]
# .. envvar:: dokuwiki_nginx_access_policy [[[
#
# Access policy defined using ``debops.nginx`` role, applied to this DokuWiki
dokuwiki_nginx_access_policy: ''

                                                                   # ]]]
# .. envvar:: dokuwiki_nginx_filename [[[
#
# Name of the ``nginx`` configuration file for DokuWiki website, without the
# ``.conf`` extension.
dokuwiki_nginx_filename: 'debops.dokuwiki'
                                                                   # ]]]
                                                                   # ]]]
# User, group, app directories [[[
# --------------------------------

# .. envvar:: dokuwiki_user [[[
#
# DokuWiki system user account.
dokuwiki_user: 'dokuwiki'

                                                                   # ]]]
# .. envvar:: dokuwiki_group [[[
#
# DokuWiki system user group.
dokuwiki_group: 'dokuwiki'

                                                                   # ]]]
# .. envvar:: dokuwiki_home [[[
#
# DokuWiki home directory.
dokuwiki_home: '{{ (ansible_local.nginx.www
                    if (ansible_local|d() and ansible_local.nginx|d() and
                        ansible_local.nginx.www|d())
                    else "/srv/www") + "/" + dokuwiki_user }}'

                                                                   # ]]]
# .. envvar:: dokuwiki_src [[[
#
# Base path for git bare repository with DokuWiki source.
dokuwiki_src: '{{ ansible_local.root.src + "/" + dokuwiki_user }}'

                                                                   # ]]]
# .. envvar:: dokuwiki_www [[[
#
# Base web root directory for DokuWiki website.
dokuwiki_www: '{{ (ansible_local.nginx.www
                   if (ansible_local|d() and ansible_local.nginx|d() and
                       ansible_local.nginx.www|d())
                   else "/srv/www") + "/" + dokuwiki_user }}'

                                                                   # ]]]
# .. envvar:: dokuwiki_webserver_user [[[
#
# DokuWiki webserver user (needs read-only access to the website code).
dokuwiki_webserver_user: '{{ ansible_local.nginx.user
                             if (ansible_local|d() and
                                 ansible_local.nginx|d() and
                                 ansible_local.nginx.user|d())
                             else "www-data" }}'
                                                                   # ]]]
                                                                   # ]]]
# Application sources [[[
# -----------------------

# .. envvar:: dokuwiki_git_repo [[[
#
# DokuWiki source repository.
dokuwiki_git_repo: 'https://github.com/splitbrain/dokuwiki.git'

                                                                   # ]]]
# .. envvar:: dokuwiki_git_dest [[[
#
# DokuWiki source directory on the host.
dokuwiki_git_dest: '{{ dokuwiki_src + "/" + dokuwiki_git_repo.split("://")[1] }}'

                                                                   # ]]]
# .. envvar:: dokuwiki_git_version [[[
#
# DokuWiki git branch to deploy.
dokuwiki_git_version: 'stable'

                                                                   # ]]]
# .. envvar:: dokuwiki_git_checkout [[[
#
# Default path where DokuWiki source files will be deployed.
dokuwiki_git_checkout: '{{ dokuwiki_www + "/sites/" + dokuwiki_domains[0] + "/public" }}'
                                                                   # ]]]
                                                                   # ]]]
# Application plugins, themes, system packages [[[
# ------------------------------------------------

# .. envvar:: dokuwiki_base_packages [[[
#
# List of base APT packages to install for DokuWiki support.
dokuwiki_base_packages: [ 'python-docutils' ]

                                                                   # ]]]
# .. envvar:: dokuwiki_packages [[[
#
# List of additional APT packages to install for DokuWiki support.
dokuwiki_packages: []

                                                                   # ]]]
# .. envvar:: dokuwiki_plugins_enabled [[[
#
# Enable or disable installation of DokuWiki plugins and templates.
dokuwiki_plugins_enabled: True

                                                                   # ]]]
# .. envvar:: dokuwiki_plugins [[[
#
# List of custom DokuWiki plugins to install.
dokuwiki_plugins: []

                                                                   # ]]]
# .. envvar:: dokuwiki_default_plugins [[[
#
# List of default DokuWiki plugins to install.
dokuwiki_default_plugins: '{{ dokuwiki_plugins_editor +
                              dokuwiki_plugins_syntax +
                              dokuwiki_plugins_git }}'

                                                                   # ]]]
# .. envvar:: dokuwiki_plugins_editor [[[
#
# DokuWiki plugins related to the text editor.
dokuwiki_plugins_editor:

  - repo: 'https://github.com/cosmocode/edittable.git'
    dest: 'edittable'

  - repo: 'https://github.com/albertgasset/dokuwiki-plugin-codemirror'
    dest: 'codemirror'

                                                                   # ]]]
# .. envvar:: dokuwiki_plugins_syntax [[[
#
# DokuWiki plugins that provide additional wiki syntax.
dokuwiki_plugins_syntax:

  - repo: 'https://github.com/cosmocode/dig.git'
    dest: 'dig'

  - repo: 'https://github.com/grantemsley/dokuwiki-plugin-patchpanel.git'
    dest: 'patchpanel'

  - repo: 'https://github.com/ashrafhasson/dokuwiki-plugin-advrack.git'
    dest: 'advrack'

  - repo: 'https://github.com/glensc/dokuwiki-plugin-pageredirect.git'
    dest: 'pageredirect'

  - repo: 'https://github.com/selfthinker/dokuwiki_plugin_wrap'
    dest: 'wrap'

  - repo: 'https://github.com/splitbrain/dokuwiki-plugin-graphviz.git'
    dest: 'graphviz'

  - repo: 'https://github.com/leibler/dokuwiki-plugin-todo.git'
    dest: 'todo'

  - repo: 'https://github.com/splitbrain/dokuwiki-plugin-gallery'
    dest: 'gallery'

  - repo: 'https://github.com/dokufreaks/plugin-tag'
    dest: 'tag'

  - repo: 'https://github.com/dokufreaks/plugin-pagelist'
    dest: 'pagelist'

  - repo: 'https://github.com/tgarc/dokuwiki-plugin-rst'
    dest: 'rst'

                                                                   # ]]]
# .. envvar:: dokuwiki_plugins_git [[[
#
# DokuWiki plugins related to ``git`` support.
dokuwiki_plugins_git:

  - repo: 'https://github.com/kossmac/dokuwiki-plugin-gitlab'
    dest: 'gitlab'

  - repo: 'https://github.com/ZJ/ghissues.git'
    dest: 'ghissues'

  - repo: 'https://github.com/splitbrain/dokuwiki-plugin-gh.git'
    dest: 'gh'

                                                                   # ]]]
# .. envvar:: dokuwiki_templates [[[
#
# List of DokuWiki templates.
dokuwiki_templates: []

                                                                   # ]]]
# .. envvar:: dokuwiki_default_templates [[[
#
# List of default DokuWiki templates.
dokuwiki_default_templates: '{{ dokuwiki_templates_vector }}'

                                                                   # ]]]
# .. envvar:: dokuwiki_templates_vector [[[
#
# The ``vector`` DokuWiki template.
dokuwiki_templates_vector:

  - repo: 'https://github.com/arsava/dokuwiki-template-vector'
    dest: 'vector'
                                                                   # ]]]
                                                                   # ]]]
# DokuWiki farm [[[
# -----------------

# .. envvar:: dokuwiki_farm [[[
#
# Enable or disable `DokuWiki farms <https://www.dokuwiki.org/farms>`_
# (the vhost variant).
dokuwiki_farm: True

                                                                   # ]]]
# .. envvar:: dokuwiki_farm_path [[[
#
# Path to animals on DokuWiki farm.
dokuwiki_farm_path: '{{ dokuwiki_www + "/farm" }}'

                                                                   # ]]]
# .. envvar:: dokuwiki_farm_animals [[[
#
# List of FQDN domains which will define "farm animals".
dokuwiki_farm_animals: []
                                                                   # ]]]
                                                                   # ]]]
# Other variables [[[
# -------------------

# .. envvar:: dokuwiki_max_file_size [[[
#
# Maximum upload size, in MB.
dokuwiki_max_file_size: '30'
                                                                   # ]]]
                                                                   # ]]]
# Configuration of other Ansible roles [[[
# ----------------------------------------

# .. envvar:: dokuwiki__php__dependent_packages [[[
#
# List of PHP packages to install using ``debops.php`` role.
dokuwiki__php__dependent_packages:

  - [ 'gmp', 'curl', 'mcrypt', 'php-net-ipv4', 'ldap' ]

                                                                   # ]]]
# .. envvar:: dokuwiki__php__dependent_pools [[[
#
# Configuration of the DokuWiki PHP-FPM pool mnaged by ``debops.php`` role.
dokuwiki__php__dependent_pools:

  - name: 'dokuwiki'
    user: '{{ dokuwiki_user }}'
    group: '{{ dokuwiki_group }}'

    php_admin_values:
      post_max_size:       '{{ dokuwiki_max_file_size }}M'
      upload_max_filesize: '{{ dokuwiki_max_file_size }}M'

                                                                   # ]]]
# .. envvar:: dokuwiki__nginx__dependent_upstreams [[[
#
# Configuration of the DokuWiki ``nginx`` upstream, used by ``debops.nginx``
# Ansible role.
dokuwiki__nginx__dependent_upstreams:

  - name: 'php_dokuwiki'
    type: 'php'
    php_pool: 'dokuwiki'

                                                                   # ]]]
# .. envvar:: dokuwiki__nginx__dependent_servers [[[
#
# Configuration of the DokuWiki ``nginx`` server, used by ``debops.nginx``
# Ansible role.
dokuwiki__nginx__dependent_servers:

  - name: '{{ dokuwiki_domains }}'
    filename: '{{ dokuwiki_nginx_filename }}'
    by_role: 'debops.dokuwiki'
    type: 'php'
    root: '{{ dokuwiki_git_checkout }}'
    access_policy: '{{ dokuwiki_nginx_access_policy }}'
    auth_basic_realm: '{{ dokuwiki_nginx_auth_realm }}'
    index: 'index.html index.htm index.php doku.php'

    options: |
      autoindex off;
      client_max_body_size {{ dokuwiki_max_file_size }}M;
      client_body_buffer_size 128k;

    location:
      '/': |
        try_files $uri $uri/ @dokuwiki;

      '@dokuwiki': |
        rewrite ^/_media/(.*)           /lib/exe/fetch.php?media=$1   last;
        rewrite ^/_detail/(.*)          /lib/exe/detail.php?media=$1  last;
        rewrite ^/_export/([^/]+)/(.*)  /doku.php?do=export_$1&id=$2  last;
        rewrite ^/(.*)                  /doku.php?id=$1               last;

      '~ ^/lib.*\.(gif|png|ico|jpg)$': |
        expires 31536000s;
        add_header Pragma "public";
        add_header Cache-Control "max-age=31536000, public, must-revalidate, proxy-revalidate";
        log_not_found off;

      '~ /(data|conf|bin|inc|install.php)/': |
        deny all;

    php_upstream: 'php_dokuwiki'
    php_options: |
      fastcgi_intercept_errors        on;
      fastcgi_ignore_client_abort     off;
      fastcgi_connect_timeout         60;
      fastcgi_send_timeout            180;
      fastcgi_read_timeout            180;
      fastcgi_buffer_size             128k;
      fastcgi_buffers               4 256k;
      fastcgi_busy_buffers_size       256k;
      fastcgi_temp_file_write_size    256k;
# ]]]
# ]]]
# ]]]
