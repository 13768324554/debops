# {{ ansible_managed }}

{% set ferm_tpl_interface = [] %}
{% set ferm_tpl_outerface = [] %}
{% set ferm_tpl_protocol = [] %}
{% set ferm_tpl_protocol_syn = [] %}
{% set ferm_tpl_saddr = [] %}
{% set ferm_tpl_dport = [] %}
{% set ferm_tpl_state = [] %}
{% if item.interface|d() %}
{%   if item.interface is string %}
{%     set ferm_tpl_interface = [ item.interface ] %}
{%   else %}
{%     set ferm_tpl_interface = item.interface | unique %}
{%   endif %}
{% elif item.interfaces|d() %}
{%   if item.interfaces is string %}
{%     set ferm_tpl_interface = [ item.interfaces ] %}
{%   else %}
{%     set ferm_tpl_interface = item.interfaces | unique %}
{%   endif %}
{% endif %}
{% if item.outerface|d() %}
{%   if item.outerface is string %}
{%     set ferm_tpl_outerface = [ item.outerface ] %}
{%   else %}
{%     set ferm_tpl_outerface = item.outerface | unique %}
{%   endif %}
{% elif item.outerfaces|d() %}
{%   if item.outerfaces is string %}
{%     set ferm_tpl_outerface = [ item.outerfaces ] %}
{%   else %}
{%     set ferm_tpl_outerface = item.outerfaces | unique %}
{%   endif %}
{% endif %}
{% if item.protocol|d() %}
{%   if item.protocol is string %}
{%     set ferm_tpl_protocol = [ item.protocol ] %}
{%   else %}
{%     set ferm_tpl_protocol = item.protocol | unique %}
{%   endif %}
{% elif item.protocols|d() %}
{%   if item.protocols is string %}
{%     set ferm_tpl_protocol = [ item.protocols ] %}
{%   else %}
{%     set ferm_tpl_protocol = item.protocols | unique %}
{%   endif %}
{% endif %}
{% if item.protocol_syn is defined %}
{%   if item.protocol_syn | bool %}
{%     set ferm_tpl_protocol_syn = [ 'syn' ] %}
{%   elif not item.protocol_syn | bool %}
{%     set ferm_tpl_protocol_syn = [ '! syn' ] %}
{%   endif %}
{% endif %}
{% if item.saddr|d() %}
{%   if item.saddr is string %}
{%     set ferm_tpl_saddr = [ item.saddr ] %}
{%   else %}
{%     set ferm_tpl_saddr = item.saddr | unique %}
{%   endif %}
{% endif %}
{% if item.dport|d() %}
{%   if item.dport is string %}
{%     set ferm_tpl_dport = [ item.dport ] %}
{%   else %}
{%     set ferm_tpl_dport = item.dport | unique %}
{%   endif %}
{% endif %}
{% if item.state|d() %}
{%   if item.state is string %}
{%     set ferm_tpl_state = [ item.state ] %}
{%   else %}
{%     set ferm_tpl_state = item.state | unique %}
{%   endif %}
{% endif %}
{% set ferm_tpl_arguments = [] %}
{% if ferm_tpl_interface %}
{%   set _ = ferm_tpl_arguments.append("interface (" + ferm_tpl_interface | join(" ") + ")") %}
{% endif %}
{% if ferm_tpl_outerface %}
{%   set _ = ferm_tpl_arguments.append("outerface (" + ferm_tpl_outerface | join(" ") + ")") %}
{% endif %}
{% if ferm_tpl_protocol %}
{%   set _ = ferm_tpl_arguments.append("protocol (" + ferm_tpl_protocol | join(" ") + ")") %}
{% endif %}
{% if ferm_tpl_protocol_syn %}
{%   set _ = ferm_tpl_arguments.append(ferm_tpl_protocol_syn | join(" ")) %}
{% endif %}
{% if ferm_tpl_dport %}
{%   set _ = ferm_tpl_arguments.append("dport (" + ferm_tpl_dport | join(" ") + ")") %}
{% endif %}
{% if ferm_tpl_state %}
{%   set _ = ferm_tpl_arguments.append("mod state state (" + ferm_tpl_state | join(" ") + ")") %}
{% endif %}
{% if item.when is undefined or item.when | bool %}
{%   if ferm_tpl_arguments %}{{ ferm_tpl_arguments | join(" ") }} {% endif %}{
{%   if item.enabled is undefined or item.enabled | bool %}
{%     if ferm_tpl_saddr|d() %}
    @def $ITEMS = ( @ipfilter( ({{ ferm_tpl_saddr | unique | join(" ") }}) ) );
    @if @ne($ITEMS,"") {
{%       if item.jump|d() %}
        saddr $ITEMS jump "{{ item.jump }}";
{%       elif item.include|d() %}
        @include "{{ item.include }}";
{%       else %}
        saddr $ITEMS {{ item.result | d("ACCEPT") }};
{%       endif %}
    }
{%     else %}
{%       if item.accept_any is defined %}
{%         if item.accept_any | bool %}
{%           if item.jump|d() %}
    jump "{{ item.jump }}";
{%           elif item.include|d() %}
    @include "{{ item.include }}";
{%           else %}
    {{ item.result | d("ACCEPT") }};
{%           endif %}
{%         elif not item.accept_any | bool %}
    # Connections from any IP address not allowed
{%         endif %}
{%       else %}
{%         if item.jump|d() %}
    jump "{{ item.jump }}";
{%         elif item.include|d() %}
    @include "{{ item.include }}";
{%         else %}
    {{ item.result | d("ACCEPT") }};
{%         endif %}
{%       endif %}
{%     endif %}
{%   endif %}
}
{% else %}
# Rule disabled by 'item.when' condition
{% endif %}

