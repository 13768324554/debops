# This file is managed by Ansible, all changes will be lost

{% if item.type is defined and item.type == 'bridge' %}
{% if (item.port_present is undefined or item.port_present in ansible_interfaces or (item.force is defined and item.force)) %}
{% if (item.port is undefined or item.port in ansible_interfaces or (item.force is defined and item.force)) %}
{% if (item.port_active is undefined or (item.port_active is defined and ((item.port|d() and item.port_active | bool == hostvars[inventory_hostname]["ansible_" + item.port|d()].active | bool) or (item.port_present|d() and item.port_active | bool == hostvars[inventory_hostname]["ansible_" + item.port_present|d()].active | bool)))) %}
# Configuration for {{ item.iface }} bridge
{% if item.auto is undefined or item.auto %}
allow-auto {{ item.iface }}
{% endif %}
{% if (item.allow is undefined and (item.inet is undefined or (item.inet is defined and item.inet != 'manual'))) %}
allow-hotplug {{ item.iface }}
{% elif (item.allow is defined and item.allow) %}
allow-{{ item.allow }} {{ item.iface }}
{% endif %}
iface {{ item.iface }} {% if item.inet is defined and item.inet %}inet {{ item.inet }}{% elif item.inet6 is defined and item.inet6 %}inet6 {{ item.inet6 }}{% else %}inet dhcp{% endif %}
{% if item.options is defined and item.options %}

{{ item.options | indent(8, true) }}
{% endif %}
{% if item.port is defined and item.port %}
{% if item.options is undefined %}

	bridge_stp on
	bridge_fd 0
	bridge_maxwait 0
{% endif %}
        bridge_ports {{ item.port }}
{% endif %}

{% if item.aliases is defined and item.aliases %}
{% for alias in item.aliases %}
iface {{ item.iface }} inet static
	address {{ alias.address }}
	netmask {{ alias.netmask }}

{% endfor %}
{% endif %}
{% else %}
# Bridge {{ item.iface }} wants interface {{ item.port|d(item.port_present|d()) }} active: {{ item.port_active }}, found: {{ hostvars[inventory_hostname]["ansible_" + item.port|d(item.port_present|d())].active }}
{% endif %}
{% else %}
# Interface {{ item.port }} not found
{% endif %}
{% else %}
# Parent interface {{ item.port_present }} not found
{% endif %}
{% else %}
# Wrong configuration for {{ item.iface }} bridge
{% endif %}

