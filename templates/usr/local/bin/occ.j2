#!/bin/bash
# Shortcut for running ownClouds `occ` command when not logged in as {{ owncloud_user }} user and sudo allows it.
# https://doc.owncloud.org/server/9.0/admin_manual/configuration_server/occ_command.html

# {{ ansible_managed }}

# Environment variable `OC_PASS` is striped normally by `sudo`.
# `--preserve-env` would preserve all environment variables.
# This should be OK for this command.
# It seems to be impossible to set "env_keep" via the command line?
# Other possibility would be to configure it properly via Defaults!{{ owncloud_home }}/occ env_keep=OC_PASS


# The occ command should be invoked with PWD set to `owncloud_home` to avoid occ not finding itâ€™s DB spec:
# https://github.com/owncloud/core/issues/17583
# It is fixed in 8.2 but lets call `occ` like the documentation suggests it:
# https://doc.owncloud.org/server/9.0/admin_manual/configuration_server/occ_command.html?highlight=occ#using-the-occ-command
cd '{{ owncloud_home }}'

sudo --preserve-env --user '{{ owncloud_user }}' php --file '{{ owncloud_home }}/occ' "$@"
